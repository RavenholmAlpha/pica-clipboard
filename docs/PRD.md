# Product Requirement Document (PRD) - PICAclip

## 1. 产品概述 (Overview)
**PICAclip** 是一款基于 Rust 和 Slint 开发的高性能、低资源占用的智能剪贴板管理工具。它不仅提供强大的剪贴板历史记录功能，还集成了结构化的便签管理和一系列效率工具，旨在提升用户的日常工作效率。

## 2. 用户故事 (User Stories)

### 2.1 剪贴板历史 (Clipboard History)
- **US-001**: 作为用户，我希望软件能自动记录我复制的所有文本、图片（引用）和文件路径，以便我稍后找回。
- **US-002**: 作为用户，我希望软件能自动过滤掉重复的复制内容和空白内容，保持列表整洁。
- **US-003**: 作为用户，我希望软件能识别并忽略敏感应用（如 1Password）的复制操作，保护我的隐私。
- **US-004**: 作为用户，我希望通过快捷键呼出面板，使用方向键选择历史记录并按回车直接粘贴到当前窗口。
- **US-011**: 作为用户，我希望将重要的剪贴板记录“置顶”，使其始终显示在列表顶部，不会被新记录挤下去。
- **US-012**: 作为用户，我希望给某条剪贴板记录打上“标签”（如 #工作, #待办），以便分类管理和快速筛选。

### 2.2 结构化便签 (Structured Snippets)
- **US-005**: 作为用户，我希望创建自定义分类（如“常用密码”、“服务器IP”），以便管理我的常用片段。
- **US-006**: 作为用户，我希望将敏感信息（如密码）标记为“脱敏”，在列表中默认显示为 `******`，只有在我需要时才查看明文。
- **US-007**: 作为用户，我希望通过同一个搜索框既能搜到历史记录，也能搜到便签内容。

### 2.3 效率工具 (Efficiency Tools)
- **US-008**: 作为用户，我希望在选中文字后触发快捷键进行即时翻译。
- **US-009**: 作为用户，我希望使用 Shift+Enter 将富文本转换为纯文本粘贴。
- **US-010**: 作为用户，我希望使用队列粘贴模式，按顺序复制多段文本，然后按顺序粘贴出来。
- **US-013**: 作为用户，我希望能通过标签（Tag）搜索历史记录，快速找到特定类别的所有内容。

## 3. 功能详细说明 (Functional Specifications)

### 3.0 界面与交互 (UI & UX)
- **双窗口策略**:
    - **主悬浮窗 (Floating Panel)**: 极简、快速响应。用于日常剪贴、搜索、翻译。失去焦点即自动隐藏。
    - **设置窗口 (Settings Window)**: 独立标准窗口。用于复杂配置、规则管理、数据清理。
- **任务栏托盘 (System Tray)**:
    - 提供常驻入口，右键菜单支持快速操作（暂停监听、打开设置、退出）。
- **浮动窗口设计**:
    - 采用类似 Windows 原生剪贴板 (Win+V) 的浮动窗口设计。
    - **呼出方式**: 全局快捷键（默认 `Ctrl+Shift+V` 或自定义）。
    - **位置**: 跟随光标位置或屏幕中心（可配置），失去焦点自动隐藏。
    - **置顶显示**: 窗口层级设置为 `AlwaysOnTop`，确保覆盖在其他应用之上。

### 3.1 核心模块 A: 智能剪贴板历史 (Smart History)

#### 3.1.1 数据流 (Data Flow)
1.  **监听 (Monitor)**: 
    - 后台线程轮询或通过系统钩子监听剪贴板变化。
    - 捕获内容类型：`Text` (纯文本 + HTML 元数据), `Image` (位图句柄 -> 保存为本地文件 -> 获取路径), `File` (文件绝对路径列表)。
2.  **处理 (Process)**:
    - **清洗**: 去除首尾空白字符 (`trim()`)。
    - **去重**: 计算内容哈希 (SHA256/MD5)，与最近一条记录比对。若相同则丢弃。
    - **隐私检查**: 检查当前活动窗口进程名是否在黑名单中 (e.g., `1Password.exe`, `KeePass.exe`)。检查内容是否匹配敏感正则 (e.g., `sk-[a-zA-Z0-9]{20,}`).
3.  **存储 (Store)**:
    - 将清洗后的数据写入 SQLite `history` 表。
    - 图片仅存储文件路径 (e.g., `~/.picaclip/cache/img_20231027_102030.png`)，严禁存入 BLOB。
    - **置顶逻辑**: 支持 `is_pinned` 标记。置顶条目在查询时优先排序。
    - **标签逻辑**: 支持关联 `tags`。
4.  **渲染 (Render)**:
    - UI 线程从 SQLite 读取最近记录（分页加载）。
    - **排序规则**: 置顶记录 > (按时间倒序)。
    - 列表项展示：类型图标 + 预览文本/缩略图 + 来源应用 + 时间 + **标签(Tags)** + **置顶标识**。
5.  **模拟粘贴 (Simulate Paste)**:
    - 用户选中条目 -> 按 Enter。
    - **Action**: 
        1. 最小化/隐藏 PICAclip 窗口。
        2. 将选中内容写回系统剪贴板。
        3. 模拟键盘事件 `Ctrl + V` (Windows API `SendInput`)。

### 3.2 核心模块 B: 结构化便签 (Structured Snippets)

#### 3.2.1 分类与标签 (Category & Tags)
- **分类**: 用于大类管理（如“工作”、“生活”），左侧边栏切换。
- **标签**: 用于灵活标记（如“#紧急”、“#参考”），支持多标签。
- **结构**: 左侧边栏展示分类列表。
- **属性**: 名称 (`name`), 图标 (`icon`), 是否锁定 (`is_locked` - 预留功能，需二次验证)。
- **操作**: 新增、重命名、删除分类；管理标签列表。

#### 3.2.2 条目管理与脱敏 (Item Management & Masking)
- **字段**: 标题 (`title`), 内容 (`content`), 所属分类 (`category_id`), 是否脱敏 (`is_masked`).
- **脱敏逻辑**:
    - **存储**: 建议对 `content` 字段进行加密存储 (AES-GCM)，密钥由用户主密码派生 (若无主密码则使用本地固定密钥混淆)。
    - **展示**: 若 `is_masked == true`:
        - 列表视图渲染为 `******`。
        - 禁用直接预览。
        - 交互：提供“眼睛”图标，鼠标悬停或点击时，临时解密并显示明文。
    - **复制/粘贴**: 即使是脱敏状态，选中并回车/复制时，应将**解密后**的明文写入剪贴板。

### 3.3 核心模块 C: 效率工具集 (Efficiency Tools)

#### 3.3.1 悬浮翻译
- 触发：全局快捷键 (e.g., `Ctrl + Q`) 或 选中并悬停 (Configurable)。
- 行为：获取选中文本 -> 调用翻译 API -> 在鼠标附近显示无边框悬浮窗 -> 展示结果。

#### 3.3.2 队列粘贴 (Queue Paste)
- 状态机：`Idle` -> `Recording (Copy)` -> `Playing (Paste)`.
- 逻辑：
    - 用户开启“队列模式”。
    - 连续执行复制操作 (Ctrl+C)，PICAclip 将内容推入内存队列 `Vec<ClipboardItem>`。
    - 用户切换到目标位置，连续执行粘贴快捷键 (自定义或检测 Ctrl+V)。
    - PICAclip 依次从队列头部弹出内容写入剪贴板并模拟粘贴。

## 4. 非功能需求 (Non-Functional Requirements)
- **性能**: 内存占用保持在 20MB 左右 (空闲时)。UI 响应时间 < 50ms。
- **存储**: SQLite 开启 WAL 模式，确保写入性能。图片缓存定期清理策略（如保留最近 30 天）。
- **兼容性**: 专注于 Windows 10/11 平台优化。
